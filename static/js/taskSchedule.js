import GSTC from"../gstc/gstc.esm.min.js";import{Plugin as CalendarScroll}from"../gstc/plugins/calendar-scroll.esm.min.js";import{Plugin as DependencyLines}from"../gstc/plugins/dependency-lines.esm.min.js";import{Plugin as HighlightWeekends}from"../gstc/plugins/highlight-weekends.esm.min.js";import{Plugin as ItemMovement}from"../gstc/plugins/item-movement.esm.min.js";import{Plugin as ItemResizing}from"../gstc/plugins/item-resizing.esm.min.js";import{Plugin as ProgressBar}from"../gstc/plugins/progress-bar.esm.min.js";import{Plugin as Selection}from"../gstc/plugins/selection.esm.min.js";import{Plugin as TimelinePointer}from"../gstc/plugins/timeline-pointer.esm.min.js";import{Plugin as TimeBookmarks}from"../gstc/plugins/time-bookmarks.esm.formatted.js";import{licensePublic}from"../gstc/keys.js";const GSTCID=GSTC.api.GSTCID,doNotSelectThisCells=[],doNotSelectThisItems=[];function canSelectItem(e){return"boolean"==typeof e.canSelect?e.canSelect:!doNotSelectThisItems.includes(e.id)}function preventSelection(e){return{"chart-timeline-grid-row-cell":e["chart-timeline-grid-row-cell"].filter(e=>!doNotSelectThisCells.includes(e.time.leftGlobalDate.format("YYYY-MM-DD"))),"chart-timeline-items-row-item":e["chart-timeline-items-row-item"].filter(e=>canSelectItem(e))}}const startDate=GSTC.api.date().subtract(2,"month").valueOf(),ccolumns=[{id:"id",label:"ID",data:({row:e})=>Number(GSTC.api.sourceID(e.id)),sortable:({row:e})=>Number(GSTC.api.sourceID(e.id)),width:80,expander:!0,header:{content:"ID"}},{id:"label",data:"label",sortable:"label",expander:!0,isHTML:!1,width:270,header:{content:"地面站"}}],hours=[{zoomTo:100,period:"hour",periodIncrement:1,format({timeStart:e}){return e.format("HH:mm DD MMMM YYYY")}}],minutes=[{zoomTo:100,period:"minute",periodIncrement:15,main:!0,format({timeStart:e,vido:t}){return t.html`<div style="text-align:center;">${e.format("HH:mm")}</div>`}}];function formateSeconds(e){let t=parseInt(e),i=0,r=0;return 60<t&&(i=parseInt(t/60),t=parseInt(t%60),60<i&&(r=parseInt(i/60),i=parseInt(i%60))),`${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function formatDateTime(e){var t=e.getFullYear(),i=(i=e.getMonth()+1)<10?"0"+i:i,r=(r=e.getDate())<10?"0"+r:r,a=(a=e.getHours())<10?"0"+a:a,n=(n=e.getMinutes())<10?"0"+n:n,e=e.getSeconds();return t+"-"+i+"-"+r+" "+a+":"+n+":"+(e=e<10?"0"+e:e)}function formatDate(e){var t=e.getFullYear(),i=(i=e.getMonth()+1)<10?"0"+i:i,e=e.getDate();return t+"-"+i+"-"+(e=e<10?"0"+e:e)}function iitemSlot(e,t){const{onChange:i,update:r,html:a,api:n,getElement:o}=e;let s,l;function m(e){s=e,l=l||tippy(s)}let c,d,p,u;return i(e=>{(t=e)&&(c=n.getItemData(t.item.id),d=c.time.startDate,p=c.time.endDate,u=`${t.item.label} 从 ${d.format("YYYY-MM-DD HH:mm:ss")} 至 ${p.format("YYYY-MM-DD HH:mm:ss")}`,r(()=>{l.setContent(u)}))}),e=>a`<div
      directive=${o(m)}
      class="my-item"
      style="width:100%;display:flex;"
    >
      ${e}
    </div>`}function rrowSlot(e,t){const{html:i,onChange:r,update:a,api:n}=e;let o="";return r(e=>{(t=e)&&(o=t.row.img,a())}),e=>"label"===n.sourceID(t.column.id)?i`<div class="row-content-wrapper" style="display:flex">
          <div class="row-content" style="flex-grow:1;">${e}</div>
          <div
            class="row-image"
            style="background:url(${o}),transparent;border-radius:100%;width:34px;height:34px;vertical-align: middle;background-size: 100%;margin: 11px 11px 0px 0px;"
          ></div>
        </div>`:e}var sstate,schedule=function(){var C={},y={},x=[],e=sessionStorage.getItem("par"),G=JSON.parse(e);(new Date).setTime(G.StartTime),(new Date).setTime(G.EndTime);var t=$("[name='checkbox_discard_less_5_minus']").is(":checked"),i=$("[name='checkbox_discard_less_10_degree']").is(":checked"),r=$("[name='checkbox_discard_reset_prepare_time']").is(":checked"),e=document.getElementById("weightMethod").selectedIndex;$("#task_table").html(""),$.post("http://8.140.167.224:8000/ScheduleOneStationMultipleStars",{SatNames:G.SatNames,StationName:G.StationName,"Start Time":G.StartTime,"End Time":G.EndTime,DiscardShortTime:t,DiscardSmallPeak:i,PrepareResetTime:r,WeightMethod:e},function(e,t){var i,r=JSON.parse(e),a=r.data,n=r.start,e=r.end,o=r.phase,s=r.route;for(i in o){var l=o[i].combined?"#FF0000":"#00FF00",m=`PHASE${i}_BEGIN`;y[m]={time:GSTC.api.date(o[i].time_interval[0]).valueOf(),label:m,color:l};m=`PHASE${i}_END`;y[m]={time:GSTC.api.date(o[i].time_interval[1]).valueOf(),label:m,color:l}}let c=0,d=0;var p,u=GSTCID(String(c));for(p in C[u]={fid:u,label:G.StationName,parentId:void 0,expanded:!0,img:"./static/radar-small.png"},c+=1,a){var g=GSTCID(String(c));C[g]={sid:g,label:p,parentId:u,expanded:!1,img:"./static/SATELLITE-small.png"};var f,S=a[p];for(f in S){var h={id:String(d++),label:S[f].label,rowId:String(c),time:{start:GSTC.api.date(S[f].time).valueOf(),end:GSTC.api.date(S[f].time).add(parseInt(S[f].duration),"second").valueOf()},style:{background:"#DA3C78"}};x.push(h)}c+=1}let T=GSTC.api.fromArray(x);var v=[];for(let e=0;e<s.length;e++){e<s.length-1&&(T[GSTCID(s[e])].dependant=[GSTCID(s[e+1])]),T[GSTCID(s[e])].style.background="#006400";var b=new Date;b.setTime(x[parseInt(s[e])].time.start);var I=formatDateTime(b);b.setTime(x[parseInt(s[e])].time.end);var w=formatDateTime(b),D=x[parseInt(s[e])].time.end-x[parseInt(s[e])].time.start,D=formateSeconds(D/=1e3),b=x[parseInt(s[e])].label.replace("#","_"),D=$('<tr id="'+b+'"><td style="width:40px">'+e.toString()+'</td><td style="width:300px">'+x[parseInt(s[e])].label+'</td><td style="width:300px">'+I+'</td><td style="width:300px">'+w+'</td><td style="width:150px">'+D+"</td><tr>");D.appendTo($("#task_table")),D.click(function(){var e,t,i=$(this).attr("id").replace("_","#");for(e in T)if(T[e].label==i){var r=T[e].time.start;console.log(r),k.api.scrollToTime(r,!1);break}for(t in v)$("#"+v[t]).css("background-color","white");$(this).css("background-color","forestgreen")}),v.push(b)}e={zoom:12,period:"hour",from:GSTC.api.date(n).startOf("hour").valueOf(),to:GSTC.api.date(e).endOf("hour").valueOf()},e={items:T,calendarLevels:[hours,minutes],time:e},e={licenseKey:licensePublic,innerHeight:385,plugins:[TimelinePointer(),Selection({events:{onEnd(e,t){var i=preventSelection(e),e=i["chart-timeline-items-row-item"];console.log("Selected item",e[0]);var r,e=e[0].label.replace("#","_"),e=$("#"+e);for(r in v)$("#"+v[r]).css("background-color","white");e.css("background-color","forestgreen");e=e.get(0);return void 0===e||(console.log(e),$("#table-container").animate({scrollTop:e.offsetTop},"slow")),i}}}),CalendarScroll(),TimeBookmarks({bookmarks:y}),DependencyLines({onLine:[e=>(e.type="3"===GSTC.api.sourceID(e.fromItem.id)?"smooth":"square",e)]})],list:{columns:{data:GSTC.api.fromArray(ccolumns)},rows:C},chart:e,scroll:{vertical:{precise:!0}},slots:{"chart-timeline-items-row-item":{content:[iitemSlot]},"list-column-row":{content:[rrowSlot]}}};sstate=GSTC.api.stateFromConfig(e);let k=GSTC({element:document.getElementById("gstc"),state:sstate});window.state=sstate,window.gstc=k})};$(document).ready(function(){schedule(),new Slider("#ex1",{formatter:function(e){return"Current value: "+e}}).on("slide",function(e){sstate.update("config.chart.time.zoom",e)}).on("change",function(e){sstate.update("config.chart.time.zoom",e.newValue)}),$("#reschedule").click(schedule),$("#export_xls").click(function(){}),$("#advanceOptions").click(function(){$("#settings_adv").modal("show")})});